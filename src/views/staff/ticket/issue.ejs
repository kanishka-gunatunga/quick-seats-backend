<%- include('../../layouts/staff-header.ejs') %>
<div class="content-page">
                <div class="content">

                    <div class="container-fluid">

                        <div class="row">
                            <div class="col-12">
                                <div class="card">
                                    <div class="card-body">
                                        <h4 class="header-title">Issue Ticket</h4>

                                        <div>
                                            <h2>Scan or Upload QR Code</h2>

                                            <!-- Live Scanner -->
                                            <div id="qr-reader" style="width: 300px;"></div>

                                            <!-- File Upload Scanner -->
                                            <div style="margin-top: 20px;">
                                                <input type="file" id="qr-file-input" accept="image/*" />
                                            </div>

                                            <!-- Display scanned data -->
                                            <div id="qr-result" style="margin-top: 20px;">
                                                <h4>Scanned QR Code Data:</h4>
                                                <pre id="decoded-data">Waiting for scan...</pre>
                                            </div>
                                        </div>

                                    </div> </div> </div>
                        </div>
                        </div> </div>

            </div>
            <%- include('../../layouts/staff-footer.ejs') %>

            <script src="https://unpkg.com/html5-qrcode"></script>

          <script>
  const qrResult = document.getElementById('decoded-data');

  function displayDecodedData(decodedText) {
    try {
      const parsed = JSON.parse(decodedText);
      qrResult.textContent = JSON.stringify(parsed, null, 2);
    } catch {
      qrResult.textContent = decodedText;
    }
  }

  // Live camera scanning
  const html5QrCode = new Html5Qrcode("qr-reader");
  const config = { fps: 10, qrbox: 250 };

  Html5Qrcode.getCameras().then(cameras => {
    if (cameras && cameras.length) {
      html5QrCode.start(
        { facingMode: "environment" },
        config,
        (decodedText) => {
          displayDecodedData(decodedText);
        },
        (error) => {
          // You can show scanning error here if needed
        }
      );
    } else {
      alert("No cameras found.");
    }
  });

  // File upload QR scanning
  const fileInput = document.getElementById('qr-file-input');
  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    try {
      const decodedText = await html5QrCode.scanFile(file, true);
      displayDecodedData(decodedText);
    } catch (err) {
      qrResult.textContent = "Failed to scan QR code from image.";
      console.error("QR scan file error: ", err);
    }
  });
</script>